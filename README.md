# Python Oni

ランダム生成された壁付きステージ上で2D鬼ごっこを行うための実験用コードです。
`stage_generator.py` による迷路生成に加え、pygame を用いた可視化および `gym`
ベースの環境 `MultiTagEnv` を用意しており、鬼も逃げも強化学習の対象となります。

## ステージ生成

```bash
python3 stage_generator.py
```

実行すると固定サイズ（例: 31x21）のステージが標準出力に表示されます。
`generate_stage` 関数に幅・高さを指定することで別サイズのステージも生成可能です。
ステージには行き止まりが存在せず、孤立したエリアも生じないよう接続性を保ったまま生成されます。道幅はランダムで広げられます。
壁密度を高めたい場合は `generate_stage(width, height, extra_wall_prob=0.1)` のように
`extra_wall_prob` を指定してください。

## 鬼ごっこ環境

以下のスクリプトで単純な鬼ごっこを実行できます。

```bash
py tag_game.py
```

また、強化学習向けには `gym_tag_env.py` に `MultiTagEnv` クラスを実装しています。`reset()` でステージとエージェントを再初期化し、`step()` では鬼と逃げのアクションをタプルで与え、観測と報酬も `(鬼, 逃げ)` のタプルで返されます。逃げ側の報酬は捕まったら `-1`、時間いっぱい逃げ切ったら `+1` です。

## 学習

以下のコマンドで必要なライブラリをインストールしてください。

```bash
pip install -r requirements.txt
```

`train.py` は 鬼と逃げを同時に学習する自作ポリシー勾配方式です。
学習中にマップと各エージェントの状態を表示したい場合は `--render` オプションを指定してください。
描画時にはステップ数の代わりに残り時間や実行回数、鬼と逃げの累積報酬が画面上部に表示されます。
`train.py` では各エピソード開始時にこれらの値を自動設定するため、表示が常に最新の状態に保たれます。

```bash
py train.py --episodes 1000 --render
```

描画更新間隔は `--render-interval` で指定できます (デフォルト1ステップごと)。
学習時間を秒単位で制限したい場合は `--duration` を用います。`--num-envs` を指定すると1つの学習で複数環境を同時に利用できます。環境の描画速度を調整する `--speed-multiplier` オプションも利用可能です。内部的には行動更新をこの倍率分だけ繰り返すため、値を大きくするほど高速に進行しますが、計算負荷によっては指定倍率通りにならないことがあります。`--duration` で指定した値は環境時間なので、`--speed-multiplier` が 2 の場合、実際の経過時間はその半分になります。交互学習モードでは `EpisodeSwapEnv` を利用し、鬼と逃げをエピソードごとに切り替えて学習します。
表示される残り時間も環境時間を基準としており、速度倍率が大きいほど実際の経過時間は短くなります。

学習後、鬼側モデルは `oni_selfplay.pth`、逃げ側モデルは `nige_selfplay.pth` として保存されます。

## 旧 self-play スクリプト

以前は `train_selfplay.py` を用いて同時学習を行っていましたが、`train.py` に統合したため基本的には使用不要です。残してありますが機能は同等です。

## コマンドラインオプション一覧

主要スクリプトで利用できる主なオプションを以下にまとめます。

### `tag_game.py`

| オプション | 説明 | デフォルト |
|------------|------|-----------|
| `--duration <秒>` | 1ゲームの制限時間 | 10.0 |

### `train.py`

| オプション | 説明 | デフォルト |
|------------|------|-----------|
| `--timesteps <int>` | 各エピソードの学習ステップ数 | 10000 |
| `--oni-model <path>` | 鬼モデルの保存/読み込みパス | `oni_policy.zip` |
| `--nige-model <path>` | 逃げモデルの保存/読み込みパス | `nige_policy.zip` |
| `--checkpoint-freq <int>` | 指定間隔でチェックポイント保存 | 0 |
| `--render` | 学習中に画面を描画 | - |
| `--render-interval <int>` | 描画間隔(ステップ数) | 1 |
| `--duration <秒>` | 各エピソードの学習時間（環境時間） | 10 |
| `--episodes <int>` | 総エピソード数 | 10 |
| `--speed-multiplier <float>` | 環境の処理速度倍率（タイマーも連動） | 1.0 |
| `--num-envs <int>` | 並列環境数 | 1 |
| `--gamma <float>` | 自作ポリシー勾配用の割引率 | 0.99 |
| `--lr <float>` | 自作ポリシー勾配用の学習率 | 3e-4 |

### `evaluate.py`

| オプション | 説明 | デフォルト |
|------------|------|-----------|
| `--oni-model <path>` | 評価用鬼モデルのパス | `oni_policy.zip` |
| `--nige-model <path>` | 評価用逃げモデルのパス | `nige_policy.zip` |
| `--episodes <int>` | 評価エピソード数 | 10 |
| `--render` | 描画を有効化 | - |
| `--speed-multiplier <float>` | 環境の処理速度倍率 | 1.0 |
